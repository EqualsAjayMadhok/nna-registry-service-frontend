name: Auto Deploy Frontend to Vercel

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Allow manual triggering from GitHub Actions tab
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Clean install dependencies
        run: |
          npm cache clean --force
          rm -rf node_modules package-lock.json
          npm install
      
      # Add timestamp to force cache invalidation
      - name: Generate timestamp
        id: timestamp
        run: echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT
        
      - name: Create production env file
        run: |
          cat > .env.production << EOL
          REACT_APP_BUILD_TIMESTAMP=${{ steps.timestamp.outputs.timestamp }}
          REACT_APP_API_URL=https://registry.reviz.dev/api
          REACT_APP_REAL_API_URL=https://registry.reviz.dev/api
          REACT_APP_ENV=production
          REACT_APP_USE_MOCK_DATA=false
          GENERATE_SOURCEMAP=false
          EOL
          echo "Created .env.production with build timestamp: ${{ steps.timestamp.outputs.timestamp }}"
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          vercel-args: '--prod --force'