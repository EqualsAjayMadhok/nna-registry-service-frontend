<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="NNA Registry Service - A taxonomy-based registry for digital assets"
    />
    <!-- Force cache refresh with a timestamp -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="build-timestamp" content="<%= Date.now() %>" />
    
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <title>NNA Registry Service</title>
    
    <!-- 🚨 EMERGENCY FIX FOR SEQUENTIAL NUMBERING 🚨 -->
    <script>
      // ⚠️ ULTRA AGGRESSIVE FIX - runs at parse time before any JS executes
      console.log("🚨 EMERGENCY SEQUENTIAL NUMBER FIX - INITIALIZE 🚨");
      
      // Intercept any functions that might set sequential numbers
      (function() {
        // Store original console.log to help with debugging
        const originalConsoleLog = console.log;
        
        // Store any functions we override so we can restore them if needed
        const originalFunctions = {};
        
        // Fix a sequential number to ensure it's at least "011"
        function fixSequentialNumber(input) {
          if (typeof input !== 'string' && typeof input !== 'number') return input;
          
          const str = String(input);
          // Check if this is a 3-digit sequential number that is "001"
          if (str === "001" || str === "1") {
            originalConsoleLog("🚨 INTERCEPTED sequential number: Changing", str, "to 011");
            return "011";
          }
          
          // Also handle other formats
          if (str.endsWith(".001")) {
            const fixed = str.replace(/\.001$/, ".011");
            originalConsoleLog("🚨 INTERCEPTED NNA address: Changing", str, "to", fixed);
            return fixed;
          }
          
          return input;
        }
        
        // Helper to wrap any function that might generate or use sequential numbers
        function wrapFunction(obj, funcName, wrapper) {
          if (!obj || typeof obj[funcName] !== 'function') return false;
          
          // Store original function
          originalFunctions[funcName] = obj[funcName];
          
          // Replace with wrapped version
          obj[funcName] = wrapper(obj[funcName]);
          
          originalConsoleLog(`🚨 WRAPPED function: ${funcName}`);
          return true;
        }
        
        // Wait for document to be fully loaded
        function setupFixOnLoad() {
          document.addEventListener('DOMContentLoaded', function() {
            originalConsoleLog("🚨 DOM LOADED - APPLYING DEEP FIXES 🚨");
            
            // Wait for scripts to load and try to intercept
            setTimeout(function() {
              tryInterceptFunctions();
              setupSequentialFixMutation();
            }, 500);
          });
        }
        
        // Try to intercept specific functions
        function tryInterceptFunctions() {
          // Look for window objects related to NNA addressing
          const targets = [
            'generateHumanFriendlyName', 
            'generateMachineFriendlyAddress',
            'getNextSequentialNumber',
            'formatSequentialNumber',
            'generateNNAAddresses'
          ];
          
          // Try window and any possible namespace objects
          [window, 
           window.nnaRegistryService, 
           window.utils, 
           window.codeMapping,
           window.nnaAddressing
          ].forEach(obj => {
            if (!obj) return;
            
            // Check each target function
            targets.forEach(funcName => {
              if (typeof obj[funcName] === 'function') {
                wrapFunction(obj, funcName, function(originalFunc) {
                  return function(...args) {
                    // Check if any argument is "001"
                    const newArgs = args.map(arg => {
                      if (typeof arg === 'number' && arg <= 1) {
                        originalConsoleLog(`🚨 INTERCEPTED function call ${funcName} with arg ${arg} -> 11`);
                        return 11; // Force to at least 11
                      }
                      return arg;
                    });
                    
                    // Call original with fixed args
                    const result = originalFunc.apply(this, newArgs);
                    
                    // Check and fix result
                    if (typeof result === 'string' && result.includes('.001')) {
                      const fixed = result.replace(/\.001/g, '.011');
                      originalConsoleLog(`🚨 INTERCEPTED function result ${funcName}: ${result} -> ${fixed}`);
                      return fixed;
                    }
                    
                    return result;
                  };
                });
              }
            });
          });
        }
        
        // Fix DOM text nodes and input values
        function fixSequentialNumbersInDOM() {
          if (!document.body) return 0;
            
          let fixCount = 0;
          
          // 1. Fix text nodes
          const walker = document.createTreeWalker(
            document.body,
            NodeFilter.SHOW_TEXT,
            null
          );
          
          let textNode;
          while (textNode = walker.nextNode()) {
            const text = textNode.nodeValue;
            
            if (text && (
              text.match(/[A-Z]\.[A-Z]{3}\.[A-Z]{3}\.001/) || 
              text.match(/[A-Z]\.[0-9]{3}\.[0-9]{3}\.001/)
            )) {
              const oldText = text;
              const newText = text.replace(/\.001/g, '.011');
              
              if (oldText !== newText) {
                textNode.nodeValue = newText;
                originalConsoleLog(`🚨 Fixed DOM text: "${oldText}" → "${newText}"`);
                fixCount++;
              }
            }
          }
          
          // 2. Fix form inputs
          const inputs = document.querySelectorAll('input, textarea, [contenteditable="true"]');
          inputs.forEach(input => {
            // Handle input values
            if (input.value && (
              input.value.match(/[A-Z]\.[A-Z]{3}\.[A-Z]{3}\.001/) || 
              input.value.match(/[A-Z]\.[0-9]{3}\.[0-9]{3}\.001/)
            )) {
              const oldValue = input.value;
              input.value = oldValue.replace(/\.001/g, '.011');
              originalConsoleLog(`🚨 Fixed input value: "${oldValue}" → "${input.value}"`);
              fixCount++;
            }
            
            // Handle contenteditable
            if (input.getAttribute('contenteditable') === 'true') {
              if (input.textContent && (
                input.textContent.match(/[A-Z]\.[A-Z]{3}\.[A-Z]{3}\.001/) || 
                input.textContent.match(/[A-Z]\.[0-9]{3}\.[0-9]{3}\.001/)
              )) {
                const oldContent = input.textContent;
                input.textContent = oldContent.replace(/\.001/g, '.011');
                originalConsoleLog(`🚨 Fixed contenteditable: "${oldContent}" → "${input.textContent}"`);
                fixCount++;
              }
            }
          });
          
          // 3. Fix element attributes that might contain NNA addresses
          const elements = document.querySelectorAll('[data-nna], [data-address], [data-id]');
          elements.forEach(el => {
            ['data-nna', 'data-address', 'data-id'].forEach(attr => {
              const value = el.getAttribute(attr);
              if (value && (
                value.match(/[A-Z]\.[A-Z]{3}\.[A-Z]{3}\.001/) || 
                value.match(/[A-Z]\.[0-9]{3}\.[0-9]{3}\.001/)
              )) {
                const oldValue = value;
                const newValue = value.replace(/\.001/g, '.011');
                el.setAttribute(attr, newValue);
                originalConsoleLog(`🚨 Fixed attribute ${attr}: "${oldValue}" → "${newValue}"`);
                fixCount++;
              }
            });
          });
          
          return fixCount;
        }
        
        // Setup MutationObserver to continuously monitor for .001 values
        function setupSequentialFixMutation() {
          let fixRunning = false;
          
          // Create visual indicator
          const indicator = document.createElement('div');
          indicator.style.position = 'fixed';
          indicator.style.bottom = '10px';
          indicator.style.right = '10px';
          indicator.style.backgroundColor = 'rgba(255, 0, 0, 0.9)';
          indicator.style.color = 'white';
          indicator.style.padding = '8px 12px';
          indicator.style.borderRadius = '5px';
          indicator.style.fontSize = '12px';
          indicator.style.fontWeight = 'bold';
          indicator.style.zIndex = '99999';
          indicator.style.boxShadow = '0 2px 8px rgba(0,0,0,0.5)';
          indicator.style.fontFamily = 'monospace';
          indicator.textContent = '🚨 EMERGENCY NNA FIX ACTIVE 🚨';
          document.body.appendChild(indicator);
          
          // Run fix immediately
          const initialCount = fixSequentialNumbersInDOM();
          originalConsoleLog(`🚨 Initial DOM fix: ${initialCount} occurrences`);

          // Set up MutationObserver to fix new content
          const observer = new MutationObserver(mutations => {
            if (fixRunning) return;
            
            fixRunning = true;
            const count = fixSequentialNumbersInDOM();
            if (count > 0) {
              // Flash the indicator
              indicator.style.backgroundColor = 'rgba(0, 255, 0, 0.9)';
              indicator.textContent = `🚨 FIXED ${count} NNA ADDRESSES 🚨`;
              setTimeout(() => {
                indicator.style.backgroundColor = 'rgba(255, 0, 0, 0.9)';
                indicator.textContent = '🚨 EMERGENCY NNA FIX ACTIVE 🚨';
              }, 1000);
            }
            fixRunning = false;
          });
          
          // Aggressive observation
          observer.observe(document.body, {
            childList: true,
            subtree: true,
            characterData: true,
            attributes: true,
            attributeFilter: ['value', 'data-nna', 'data-address', 'data-id']
          });
          
          originalConsoleLog("🚨 EMERGENCY FIX COMPLETED: Now monitoring for '001' NNA addresses");
        }
        
        // Monkey patch console.log to intercept NNA logging
        console.log = function(...args) {
          // Call original first to ensure we see all logs
          originalConsoleLog.apply(console, args);
          
          // Check for NNA addresses in logs
          if (args.length > 0 && typeof args[0] === 'string') {
            if (args[0].includes('NNA address updated')) {
              // This is likely a log about NNA addressing
              for (let i = 0; i < args.length; i++) {
                if (typeof args[i] === 'string' && (
                  args[i].match(/[A-Z]\.[A-Z]{3}\.[A-Z]{3}\.001/) || 
                  args[i].match(/[A-Z]\.[0-9]{3}\.[0-9]{3}\.001/)
                )) {
                  originalConsoleLog(`🚨 DETECTED NNA ADDRESS IN LOG: "${args[i]}"`);
                  
                  // Force a DOM fix after a short delay to let the UI update
                  setTimeout(fixSequentialNumbersInDOM, 100);
                  setTimeout(fixSequentialNumbersInDOM, 500);
                  setTimeout(fixSequentialNumbersInDOM, 1000);
                }
              }
            }
          }
        };
        
        // Direct override of known module calls
        window.MIN_SEQUENTIAL_NUMBER = 11;
        
        // Setup on load
        setupFixOnLoad();
        
        // Also run the fix repeatedly to catch any missed items
        setInterval(fixSequentialNumbersInDOM, 2000);
      })();
    </script>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
  </body>
</html>
